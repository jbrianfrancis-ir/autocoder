---
phase: 04-context-optimization
plan: 01
type: execute
---

<objective>
Optimize agent context usage by converting JSON responses to token-efficient markdown format.

Purpose: Reduce token consumption in agent context by following Ralph Wiggum's "markdown over JSON" principle. JSON serialization includes structural overhead (quotes, brackets, commas) that consumes tokens without adding semantic value.

Output: MCP tool responses in markdown format, token budget guidance documented.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency chain):
@.planning/phases/03-backpressure-validation/03-01-SUMMARY.md

# Key files to modify:
@mcp_server/feature_mcp.py

# Reference for Ralph Wiggum patterns:
# - Markdown over JSON deliberately for token efficiency
# - Allocate ~5,000 tokens to specs upfront
# - Plans are human-readable prose, not structured serialization

**Tech stack available:**
- FastMCP for MCP server
- SQLAlchemy for database
- Spec parser producing markdown

**Established patterns:**
- Specs as markdown source of truth (Phase 1)
- Structured claude-progress.txt sections (Phase 2)
- Validation gates before commits (Phase 3)

**Constraining decisions:**
- Phase 01-01: YAML frontmatter for spec metadata
- Phase 01-03: Include full spec in feature_get_next response
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert MCP tool responses from JSON to markdown</name>
  <files>mcp_server/feature_mcp.py</files>
  <action>
Refactor MCP tool return values from `json.dumps()` to markdown-formatted strings:

**feature_get_stats:**
```
FROM: {"passing": 5, "in_progress": 1, "total": 10, "percentage": 50.0}
TO:
## Progress
- Passing: 5/10 (50.0%)
- In Progress: 1
- Remaining: 4
```

**feature_get_next:**
```
FROM: {"id": 1, "priority": 1, "category": "functional", "name": "...", ...}
TO:
## Next Feature

**ID:** 1 | **Priority:** 1 | **Category:** functional | **Status:** pending

### Name
User Login

### Description
[description text]

### Test Steps
1. First step
2. Second step

### Spec File
`specs/01-user-login.md`
```

**feature_mark_passing, feature_skip, etc.:**
```
FROM: {"id": 1, "name": "...", "passes": true, ...}
TO:
Feature marked passing: **User Login** (ID: 1)
```

**Error responses:**
```
FROM: {"error": "Feature not found"}
TO:
**Error:** Feature not found
```

Keep `feature_create_bulk` as JSON (initialization tool, not agent context optimization target).

Why markdown: Each `{"` pair = 2 tokens. Markdown uses whitespace/newlines which tokenize more efficiently. Lists with `-` or `1.` are clearer than JSON arrays.
  </action>
  <verify>
Run the MCP server and call each tool to verify markdown output:
```bash
cd /home/brianf/dev/autocoder
python -c "
from mcp_server.feature_mcp import mcp
# Server initialization would be needed for real test
print('MCP server imports successfully')
"
```
Manually verify string returns are markdown-formatted (not json.dumps calls).
  </verify>
  <done>
- All agent-facing MCP tools return markdown strings
- feature_create_bulk remains JSON (bulk import utility)
- No json.dumps in tool return paths (except errors and bulk create)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add format_feature_markdown helper function</name>
  <files>mcp_server/feature_mcp.py</files>
  <action>
Create a reusable helper function to format Feature objects as markdown:

```python
def format_feature_markdown(feature: Feature, include_spec: bool = False, spec_content: dict = None) -> str:
    """Format a Feature as markdown for token-efficient agent consumption."""
    lines = [
        f"**ID:** {feature.id} | **Priority:** {feature.priority} | **Category:** {feature.category} | **Status:** {'passing' if feature.passes else 'in_progress' if feature.in_progress else 'pending'}",
        "",
        f"### {feature.name}",
        "",
        feature.description,
        "",
        "### Test Steps",
    ]
    for i, step in enumerate(feature.steps, 1):
        lines.append(f"{i}. {step}")

    if include_spec and spec_content:
        lines.extend([
            "",
            f"### Spec File",
            f"`{spec_content.get('filepath', 'N/A')}`",
        ])

    return "\n".join(lines)
```

Use this helper in `feature_get_next`, `feature_mark_passing`, `feature_mark_in_progress`, `feature_clear_in_progress`, and `feature_get_for_regression` to ensure consistent markdown formatting.

Why a helper: DRY principle - feature formatting is used in 5+ tools. Centralizing ensures consistency and makes future format changes easy.
  </action>
  <verify>
Grep for the helper function and its usage:
```bash
grep -n "format_feature_markdown" mcp_server/feature_mcp.py
```
Should show function definition and multiple call sites.
  </verify>
  <done>
- format_feature_markdown function exists
- Used by all feature-returning tools
- Consistent markdown output across tools
  </done>
</task>

<task type="auto">
  <name>Task 3: Document token budget guidance in AGENTS.md template</name>
  <files>.claude/templates/agents.template.md</files>
  <action>
Add a "Context Efficiency" section to the AGENTS.md template with token budget guidance:

```markdown
## Context Efficiency

**Token Budget Targets:**
- Spec files: ~5,000 tokens upfront (read relevant specs at session start)
- Progress check: ~200 tokens (feature_get_stats output)
- Next feature: ~500 tokens (feature_get_next markdown output)
- Reserve ~70% context for implementation work

**Patterns:**
- MCP tools return markdown (not JSON) for efficient tokenization
- Read only structured sections of claude-progress.txt (Known Issues, Blocked Features, Next Session)
- Avoid re-reading full file contents if you have recent context
```

Keep AGENTS.md under 60 lines total (established constraint from Phase 1).
  </action>
  <verify>
```bash
wc -l .claude/templates/agents.template.md
```
Should be under 60 lines.
  </verify>
  <done>
- Context Efficiency section added
- Token budget targets documented
- AGENTS.md remains under 60 lines
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] MCP server imports without errors
- [ ] feature_get_stats returns markdown (not JSON)
- [ ] feature_get_next returns markdown with readable feature info
- [ ] format_feature_markdown helper exists and is used
- [ ] AGENTS.md template has Context Efficiency section
- [ ] AGENTS.md template is under 60 lines
- [ ] `ruff check mcp_server/feature_mcp.py` passes
- [ ] `mypy mcp_server/feature_mcp.py --ignore-missing-imports` passes (or no new errors)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No Python syntax/type errors introduced
- MCP tools return markdown instead of JSON for agent consumption
- Token budget guidance documented for future projects
</success_criteria>

<output>
After completion, create `.planning/phases/04-context-optimization/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Context Optimization Summary

**[Substantive one-liner]**

## Accomplishments

- Converted MCP tool responses from JSON to markdown
- Added format_feature_markdown helper for consistency
- Documented token budget guidance in AGENTS.md

## Files Created/Modified

- `mcp_server/feature_mcp.py` - Markdown output format
- `.claude/templates/agents.template.md` - Context Efficiency section

## Decisions Made

[Key decisions]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete, ready for Phase 5: Sandbox Hardening
</output>
