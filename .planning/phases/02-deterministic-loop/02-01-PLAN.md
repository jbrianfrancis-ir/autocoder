---
phase: 02-deterministic-loop
plan: 01
type: execute
---

<objective>
Analyze current agent session architecture and design deterministic loop improvements.

Purpose: Verify how deterministic the current loop is, identify gaps against Ralph Wiggum patterns, and decide on the approach for ensuring identical context each iteration.

Output: Analysis document with findings, decision on state management approach, ready for implementation in 02-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/01-spec-driven-architecture/01-03-SUMMARY.md

**Key files to analyze:**
@agent.py
@client.py
@prompts.py
@progress.py
@.claude/templates/coding_prompt.template.md

**Ralph Wiggum reference patterns:**
- `cat PROMPT.md | claude` loop with identical context each iteration
- One task per loop = 100% context utilization
- Monolithic single-task operation before exit
- Fresh start architecture - no conversation memory
- File-based state via IMPLEMENTATION_PLAN.md

**From Phase 1:**
- Hybrid architecture established: specs for content, database for status
- `feature_get_next` returns single feature (one task per loop)
- Specs are authoritative for WHAT, database tracks PROGRESS
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze current session architecture</name>
  <files>agent.py, client.py, prompts.py, progress.py</files>
  <action>
Trace through the agent session flow to document:

1. **Session initialization** - How `create_client()` creates fresh context
2. **Prompt loading** - How `get_coding_prompt()` produces the prompt
3. **State checks** - What `has_features()` and `print_progress_summary()` read
4. **Session scoping** - How `async with client:` bounds the session
5. **Auto-continue** - What happens between sessions in the while loop

Document findings in a structured analysis:
- What IS deterministic (same each session)
- What is NOT deterministic (varies between sessions)
- What external state is read (files, database)
- What external state is written (files, database)

Create analysis file: `.planning/phases/02-deterministic-loop/02-ANALYSIS.md`
  </action>
  <verify>File exists and contains structured analysis of all 5 areas</verify>
  <done>Analysis document created with clear findings on determinism gaps</done>
</task>

<task type="auto">
  <name>Task 2: Assess claude-progress.txt role</name>
  <files>.claude/templates/coding_prompt.template.md, .claude/templates/coding_prompt_yolo.template.md</files>
  <action>
Analyze the role of `claude-progress.txt` in the current system:

1. **What prompt instructs** - Find all references in prompt templates
2. **What agent writes** - Determine what information goes into the file
3. **What agent reads** - Determine what context is extracted from file
4. **Determinism impact** - Does reading this file create session-to-session variance?
5. **Value assessment** - What would be lost if this file were removed?

Compare against Ralph Wiggum's IMPLEMENTATION_PLAN.md pattern:
- Ralph uses structured task list updated during build
- Our claude-progress.txt is unstructured prose notes
- Ralph's plan drives next task; our feature_get_next does this instead

Add findings to the analysis document under "## claude-progress.txt Assessment"
  </action>
  <verify>Analysis document has claude-progress.txt section with value/risk assessment</verify>
  <done>Clear recommendation on whether to keep, structure, or remove claude-progress.txt</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Select deterministic state management approach</decision>
  <context>
The current system has a hybrid approach:
- Specs (files) for feature content
- Database for feature status (passes, in_progress)
- claude-progress.txt for session notes

Ralph Wiggum uses pure file-based state via IMPLEMENTATION_PLAN.md.

The question: How should we handle session-to-session state to maximize determinism while preserving useful context?
  </context>
  <options>
    <option id="remove-progress">
      <name>Remove claude-progress.txt entirely</name>
      <pros>Maximum determinism - every session starts identical. Aligns with fresh-start architecture. Reduces complexity.</pros>
      <cons>Lose human-readable session notes. Debugging harder. No breadcrumb trail for humans reviewing agent work.</cons>
    </option>
    <option id="structure-progress">
      <name>Structure claude-progress.txt with defined sections</name>
      <pros>Keeps human-readable notes. Can make agent read only specific sections. Maintains debugging value.</pros>
      <cons>Still introduces session variance. More complex to implement correctly. Agent may write inconsistently.</cons>
    </option>
    <option id="read-only-progress">
      <name>Make claude-progress.txt write-only (agent writes, never reads)</name>
      <pros>Preserves breadcrumb trail for humans. Agent gets identical context each session. Simple to implement.</pros>
      <cons>Agent can't learn from prior session notes. May duplicate work if it can't see what was tried before.</cons>
    </option>
    <option id="keep-current">
      <name>Keep current approach (minor cleanup only)</name>
      <pros>Already works. Feature_get_next provides deterministic task selection. Minimal change risk.</pros>
      <cons>Session context varies. Not fully aligned with Ralph Wiggum pattern. May cause inconsistent behavior.</cons>
    </option>
  </options>
  <resume-signal>Select: remove-progress, structure-progress, read-only-progress, or keep-current</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Analysis document exists at `.planning/phases/02-deterministic-loop/02-ANALYSIS.md`
- [ ] All 5 session architecture areas documented
- [ ] claude-progress.txt role assessed with clear recommendation
- [ ] Decision made on state management approach
- [ ] Decision rationale documented in analysis
</verification>

<success_criteria>
- Analysis document created with comprehensive findings
- All prompt template references to claude-progress.txt identified
- Clear understanding of what varies vs stays constant between sessions
- Decision checkpoint completed with chosen approach
- Ready for 02-02 implementation plan
</success_criteria>

<output>
After completion, create `.planning/phases/02-deterministic-loop/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Deterministic Loop Analysis & Design Summary

**[One-liner: what was discovered and decided]**

## Accomplishments

- Session architecture analyzed
- claude-progress.txt role assessed
- Deterministic state approach chosen

## Analysis Findings

[Key discoveries about current determinism]

## Decision Made

[Which approach was selected and why]

## Files Created/Modified

- `.planning/phases/02-deterministic-loop/02-ANALYSIS.md` - Full analysis

## Next Step

Ready for 02-02-PLAN.md (Deterministic Loop Implementation)
</output>
