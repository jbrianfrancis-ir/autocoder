---
phase: 02-deterministic-loop
plan: 02
type: execute
---

<objective>
Implement deterministic loop improvements based on 02-01 analysis and decision.

Purpose: Ensure agent sessions start from identical context each iteration, following Ralph Wiggum's fresh-start architecture pattern.

Output: Updated prompt templates, modified state handling, documented architecture in AGENTS.md template.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan context (MUST READ FIRST):**
@.planning/phases/02-deterministic-loop/02-01-SUMMARY.md
@.planning/phases/02-deterministic-loop/02-ANALYSIS.md

**Files to modify:**
@.claude/templates/coding_prompt.template.md
@.claude/templates/coding_prompt_yolo.template.md
@.claude/templates/agents.template.md

**Decision from 02-01 determines implementation:**
- `remove-progress`: Remove all claude-progress.txt references from prompts
- `structure-progress`: Add structured sections to prompt instructions
- `read-only-progress`: Modify prompts to write but not read progress file
- `keep-current`: Minor cleanup only, document existing behavior
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement chosen state management approach</name>
  <files>.claude/templates/coding_prompt.template.md, .claude/templates/coding_prompt_yolo.template.md</files>
  <action>
Based on decision from 02-01-SUMMARY.md, implement the chosen approach:

**If remove-progress:**
- Remove all `cat claude-progress.txt` references from prompts
- Remove "Update claude-progress.txt" from Step 9
- Remove progress file from Step 10 checklist
- Keep git history reading (that's deterministic - same commits each time)

**If structure-progress:**
- Define specific sections in prompt: `## Session Notes`, `## Blockers`, `## Next Priority`
- Agent reads only `## Next Priority` section
- Agent writes to all sections but structured format
- Add parsing instructions to prompt

**If read-only-progress:**
- Remove `cat claude-progress.txt` from Step 1 (Get Your Bearings)
- Keep write instructions in Step 9
- Add comment: "This file is for human review only, not agent context"

**If keep-current:**
- Document current behavior in AGENTS.md
- Minor cleanup of prompt wording if needed
- No functional changes

Apply same changes to both coding_prompt.template.md and coding_prompt_yolo.template.md.
  </action>
  <verify>Prompt templates updated according to chosen approach. Diff shows expected changes.</verify>
  <done>State management implemented consistently across both prompt templates</done>
</task>

<task type="auto">
  <name>Task 2: Ensure prompt seeding consistency</name>
  <files>.claude/templates/coding_prompt.template.md, .claude/templates/coding_prompt_yolo.template.md</files>
  <action>
Review and ensure prompts produce identical context regardless of session number:

1. **Static sections** - Verify all instructional content is hardcoded (not dynamic)
2. **File reads in prompt** - Ensure any `cat` commands read deterministic content:
   - `cat AGENTS.md` - OK (static operational reference)
   - `ls specs/` - OK (same files each session)
   - `git log --oneline -20` - OK (same commits each session)
   - `cat claude-progress.txt` - VARIES (address per decision)

3. **MCP tool calls** - Verify deterministic behavior:
   - `feature_get_stats` - Returns current counts (deterministic from DB state)
   - `feature_get_next` - Returns highest priority pending (deterministic from DB state)

4. **Session-specific content** - Identify and document any intentional variance:
   - Session number in header (cosmetic, acceptable)
   - Timestamp in commits (unavoidable, acceptable)

Document any remaining variance sources in the analysis document.

If any non-deterministic elements found beyond claude-progress.txt, address them or document why they're acceptable.
  </action>
  <verify>Review both templates confirm all file reads and tool calls are deterministic or intentionally variant</verify>
  <done>Prompt seeding verified consistent, any variance documented and justified</done>
</task>

<task type="auto">
  <name>Task 3: Document deterministic loop architecture in AGENTS.md template</name>
  <files>.claude/templates/agents.template.md</files>
  <action>
Add a "## Session Architecture" section to the AGENTS.md template explaining the deterministic loop:

```markdown
## Session Architecture

This project uses a **deterministic fresh-start loop**:

- Each agent session starts with identical context
- Session state via database (feature passes/in_progress)
- One feature per session = 100% context utilization
- Agent exits cleanly, process restarts with fresh context

**State Management:**
- `specs/` - Feature requirements (source of truth)
- `features.db` - Progress tracking (passes, in_progress)
- [Document chosen claude-progress.txt approach]

**Session Flow:**
1. Fresh client created (no conversation memory)
2. Prompt loaded from template (identical each session)
3. feature_get_next returns one task
4. Agent implements, verifies, marks passing
5. Session ends, loop restarts
```

Keep the section concise (<20 lines) to stay within AGENTS.md's 60-line guidance.
  </action>
  <verify>AGENTS.md template has Session Architecture section under 20 lines</verify>
  <done>Deterministic loop documented in operational reference template</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Prompt templates modified per chosen approach
- [ ] Both coding_prompt.template.md and coding_prompt_yolo.template.md updated consistently
- [ ] Prompt seeding verified deterministic (or variance documented)
- [ ] AGENTS.md template has Session Architecture section
- [ ] All changes committed
</verification>

<success_criteria>
- Prompt templates implement chosen state management approach
- No unintended session-to-session variance in prompts
- Deterministic loop architecture documented in AGENTS.md
- Phase 2 complete and ready for Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/02-deterministic-loop/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Deterministic Loop Implementation Summary

**[One-liner: what was implemented]**

## Accomplishments

- [State management approach implemented]
- [Prompt seeding verified]
- [Architecture documented]

## Files Created/Modified

- `.claude/templates/coding_prompt.template.md` - [changes]
- `.claude/templates/coding_prompt_yolo.template.md` - [changes]
- `.claude/templates/agents.template.md` - Added Session Architecture section

## Decisions Made

[Any implementation decisions beyond 02-01]

## Issues Encountered

[Problems and resolutions, or "None"]

## Phase 2 Complete

Phase 2: Deterministic Loop is complete. Ready for Phase 3: Backpressure Validation.
</output>
