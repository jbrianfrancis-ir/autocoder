# Phase 5 Plan 1: Sandbox Hardening - Quick Wins

**Phase**: 05-sandbox-hardening
**Plan**: 01 of 02
**Scope**: Small (~30 min)
**Prerequisites**: Phase 4 complete

<objective>
Implement high-impact, low-effort security improvements: fix CORS configuration, add symlink attack mitigation, and document explicit blast radius.

**Key outcomes:**
- CORS restricted to specific localhost origins instead of wildcard
- Symlink checks prevent path traversal attacks in filesystem.py
- Security posture documented as BLAST_RADIUS.md
</objective>

<execution_context>
**Load first:**
@.planning/phases/05-sandbox-hardening/05-RESEARCH.md (code examples, patterns)
@.planning/codebase/CONCERNS.md (specific issues to address)

**Reference:**
@.planning/codebase/ARCHITECTURE.md (security layer overview)
</execution_context>

<context>
**From Phase Research (05-RESEARCH.md):**
- CORS `allow_origins=["*"]` is security vulnerability (CONCERNS.md line 7-12)
- Symlink attacks via `Path.resolve()` on untrusted input (CONCERNS.md line 42-46)
- Defense-in-depth requires explicit blast radius documentation

**Current state:**
- `server/main.py:59` - CORS set to `["*"]`
- `server/routers/filesystem.py:128, 213` - `resolve()` called before symlink check
- No blast radius documentation exists

**From prior phases:**
- Phase 3: Validation gates pattern for blocking failures
- Phase 4: Context optimization complete, ready for security hardening
</context>

<tasks>
## Task 1: Fix CORS Configuration

**Objective:** Replace wildcard CORS with specific localhost origins

**Files:**
- `server/main.py` - Update CORSMiddleware configuration

**Steps:**
1. Read `server/main.py` to understand current CORS setup
2. Replace `allow_origins=["*"]` with specific origins:
   ```python
   allow_origins=[
       "http://localhost:5173",
       "http://127.0.0.1:5173",
       "http://localhost:8000",
       "http://127.0.0.1:8000",
   ]
   ```
3. Update comment to reflect change

**Verification:**
- [ ] `mypy server/main.py` passes
- [ ] Server starts without errors

**Commit:** `fix(05-01): restrict CORS to localhost origins`

---

## Task 2: Add Symlink Attack Mitigation

**Objective:** Validate paths for symlinks before resolution to prevent path traversal

**Files:**
- `server/routers/filesystem.py` - Add symlink detection helper and validation

**Steps:**
1. Read `server/routers/filesystem.py` for current path handling
2. Add `is_symlink_escape()` helper function based on research pattern:
   ```python
   def is_symlink_escape(path: Path, base_path: Path) -> bool:
       """Check if path is a symlink pointing outside base directory."""
       if not path.is_symlink():
           return False
       target = path.resolve()
       try:
           target.relative_to(base_path.resolve())
           return False  # Target is within base
       except ValueError:
           return True  # Target escapes base
   ```
3. Update `is_path_blocked()` to check for symlinks BEFORE calling `resolve()`
4. Add symlink check in `list_directory()` before resolving user-provided paths

**Verification:**
- [ ] `mypy server/routers/filesystem.py` passes
- [ ] Existing filesystem tests pass (if any)

**Commit:** `fix(05-01): add symlink escape detection in filesystem router`

---

## Task 3: Document Blast Radius

**Objective:** Create explicit documentation of security posture and blast radius

**Files:**
- `.planning/codebase/BLAST_RADIUS.md` - New file documenting security boundaries

**Steps:**
1. Create BLAST_RADIUS.md with sections:
   - What a compromised agent CAN access
   - What a compromised agent CANNOT access
   - Current security layers (allowlist, filesystem sandbox, output sanitization)
   - Known gaps and mitigations
2. Include specific file references and command counts
3. Document the 57-command allowlist scope

**Template from research:**
```markdown
## Blast Radius (AutoCoder)

**If agent is compromised, attacker can:**
- Execute 57 whitelisted commands within project directory
- Read/write files in project directory only
- Access environment variables visible to Python process
- Make network requests (no restrictions currently)
- Access any API keys passed via environment

**Attacker CANNOT:**
- Execute arbitrary commands (blocked by allowlist)
- Access files outside project directory (blocked by security.py)
- Modify system files (no sudo/su access)
- Install system packages (apt/yum not in allowlist)
```

**Verification:**
- [ ] Document references correct file paths
- [ ] Allowlist count matches security.py

**Commit:** `docs(05-01): document explicit security blast radius`
</tasks>

<verification>
After all tasks:
1. `mypy server/` - No new type errors
2. Server starts: `python -c "from server.main import app; print('OK')"`
3. BLAST_RADIUS.md exists and is accurate
4. CORS change verified in code
5. Symlink helper function exists and is called
</verification>

<success_criteria>
- [ ] CORS restricted to localhost-only origins
- [ ] Symlink escape detection added to filesystem router
- [ ] BLAST_RADIUS.md documents security posture
- [ ] All verification checks pass
- [ ] No regressions introduced
</success_criteria>

<output>
**Files modified:**
- `server/main.py` - CORS configuration
- `server/routers/filesystem.py` - Symlink detection

**Files created:**
- `.planning/codebase/BLAST_RADIUS.md` - Security documentation

**Decisions to document:**
- Specific localhost origins chosen for CORS
- Symlink check happens before path resolution
- Blast radius documented in codebase directory for discoverability
</output>

---
*Plan created: 2026-01-11*
*Phase: 05-sandbox-hardening*
*Depends on: Phase 4 (complete)*
