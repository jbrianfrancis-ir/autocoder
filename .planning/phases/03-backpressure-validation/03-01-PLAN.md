---
phase: 03-backpressure-validation
plan: 01
type: execute
---

<objective>
Add validation gates (lint/type-check/build) as backpressure before commits in agent prompts.

Purpose: Enforce code quality through explicit validation steps that must pass before committing, following Ralph Wiggum's "backpressure-driven validation" pattern.
Output: Updated prompt templates with validation gates and failure pattern guardrails.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/02-deterministic-loop/02-02-SUMMARY.md

# Key files to modify:
@.claude/templates/coding_prompt.template.md
@.claude/templates/coding_prompt_yolo.template.md
@.claude/templates/agents.template.md

**Current state:**
- YOLO mode has lint/type-check as explicit step (STEP 5)
- Standard mode has browser testing but NO explicit lint/type-check before commits
- No documented failure pattern guardrails in either template

**Ralph Wiggum pattern:**
- "Anything can be wired in as back pressure to reject invalid code generation"
- Tests, type-checking, linting force correctness before commits
- Failure patterns trigger prompt guardrails

**Gap to fill:**
- Standard mode needs explicit validation gates step before commit
- Both modes need common failure pattern guardrails
- AGENTS.md template needs backpressure documentation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation gates step to standard coding prompt</name>
  <files>.claude/templates/coding_prompt.template.md</files>
  <action>
Insert new "STEP 7.5: VALIDATION GATES" between current STEP 7 (UPDATE FEATURE STATUS) and STEP 8 (COMMIT YOUR PROGRESS).

Content should include:
1. Run lint command (language-appropriate)
2. Run type-check command (language-appropriate)
3. Run build command if applicable
4. Explicit instruction: "Fix ALL errors before proceeding to commit"
5. Backpressure principle: "Validation gates are BLOCKING - you cannot commit until they pass"

Model after YOLO mode's STEP 5 structure but adapted for standard mode.

Also renumber subsequent steps:
- Current STEP 8: COMMIT → becomes STEP 9
- Current STEP 9: UPDATE PROGRESS NOTES → becomes STEP 10
- Current STEP 10: END SESSION CLEANLY → becomes STEP 11
  </action>
  <verify>grep -n "VALIDATION GATES" .claude/templates/coding_prompt.template.md shows the new section exists</verify>
  <done>Standard coding prompt has explicit validation gates step with lint/type-check/build before commit step</done>
</task>

<task type="auto">
  <name>Task 2: Add failure pattern guardrails to both prompts</name>
  <files>.claude/templates/coding_prompt.template.md, .claude/templates/coding_prompt_yolo.template.md</files>
  <action>
Add new section "## COMMON FAILURE PATTERNS" after the TESTING REQUIREMENTS section (standard) or before FEATURE TOOL USAGE RULES section (YOLO).

Include guardrails for:

**TypeScript Errors:**
- "Cannot find module" → Check import paths, ensure file exists
- "Type 'X' is not assignable to type 'Y'" → Review type definitions, add proper type annotations
- "Property 'X' does not exist on type 'Y'" → Check for typos, verify interface definitions

**Python Errors:**
- "IndentationError" → Fix whitespace (use 4 spaces, not tabs)
- "ImportError" → Verify module installed, check import path
- "TypeError: 'NoneType'" → Add null checks before accessing properties

**Build Failures:**
- "Module not found" → Run npm install / pip install
- "Compilation failed" → Check all type errors are resolved first

**General pattern:**
"If validation fails, you MUST fix the issue before committing. Do NOT proceed with broken code."
  </action>
  <verify>grep -n "COMMON FAILURE PATTERNS" .claude/templates/coding_prompt.template.md .claude/templates/coding_prompt_yolo.template.md shows section in both files</verify>
  <done>Both prompt templates have failure pattern guardrails section</done>
</task>

<task type="auto">
  <name>Task 3: Document backpressure in AGENTS.md template</name>
  <files>.claude/templates/agents.template.md</files>
  <action>
Update the "Session Architecture" section to include backpressure validation flow.

Expand the **Flow:** line to show validation gates:
```
**Flow:** Fresh client → prompt loaded → `feature_get_next` → implement → validate (lint/type/build) → verify → mark passing → commit → exit
```

Add brief backpressure note (keep section under 15 lines total):
```
**Validation gates:** Lint, type-check, and build must pass before commits. Fix errors before proceeding.
```

Ensure AGENTS.md template stays under 60 lines total.
  </action>
  <verify>wc -l .claude/templates/agents.template.md shows < 60 lines; grep "Validation gates" shows the new content</verify>
  <done>AGENTS.md template documents validation backpressure flow within line limit</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Standard coding prompt has STEP 7.5: VALIDATION GATES
- [ ] Subsequent steps renumbered correctly (STEP 8→9, STEP 9→10, STEP 10→11)
- [ ] Both prompts have "COMMON FAILURE PATTERNS" section
- [ ] AGENTS.md template includes validation gates in flow
- [ ] AGENTS.md template is under 60 lines
- [ ] All changes committed with atomic task commits
</verification>

<success_criteria>

- All 3 tasks completed
- Validation gates explicitly documented in standard prompt
- Failure pattern guardrails in both prompts
- AGENTS.md updated with backpressure flow
- Line count constraints maintained
</success_criteria>

<output>
After completion, create `.planning/phases/03-backpressure-validation/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Backpressure Validation Gates Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [File list with descriptions]

## Decisions Made

- [Decisions and rationale]

## Issues Encountered

- [Problems and resolutions, or "None"]

## Next Step

Phase 3 complete, ready for Phase 4: Context Optimization
</output>
